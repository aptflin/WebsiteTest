<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <title>DeviceOrientation & Firebase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="src/playing2.css">
</head>

<body>

  <img src="src/untitled.png" class="arrow" alt="箭頭">
  <div class="container">
    <!-- 左上角光效 -->
    <img src="src/leftlight.png" class="left-light" alt="左光">
    <!-- 左上角色圖 -->
    <img src="src/BlueArea.png" class="character" alt="角色地圖">
    <!-- 中央 Round 標題 -->
    <div class="round-info">
      <h2 class="round-title">ROUND</h2>
      <h1 class="round-number">1</h1>
      <div id="number">0</div>
    </div>
    <!-- 中央箭頭提示 
    <img src="src/bigarrow.png" class="arrow" alt="箭頭提示"> -->
    <div>
      <!-- 右下角光效 -->
      <img src="src/rightlight.png" class="right-light" alt="右光">
      <!-- 右下角 GOAL -->
      <img src="src/goal.png" class="goal" alt="終點路徑">
      <h2 class="goal-text">GOAL!</h2>
      <!-- 光球回饋 --> <!-- 新加了這個div class!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! -->
      <div class="color-lights">
        <div class="light-ball white" style="top: 304.5px; left: 585px;"></div>
        <div class="light-ball yellow" style="top: 256.5px; left: 638px;"></div>
        <div class="light-ball magenta" style="top: 220.5px; left: 700px;"></div>
        <div class="light-ball cyan" style="top: 196.5px; left: 765px;"></div>
      </div>
    </div>
  </div>

  <!-- 這是阿踢 -->
  <script>
    let ws = new WebSocket('wss://websitetest-xx30.onrender.com');
    const ballCyan = document.querySelectorAll('.light-ball.cyan');
    const ballMagenta = document.querySelectorAll('.light-ball.magenta');
    const ballYellow = document.querySelectorAll('.light-ball.yellow');
    const ballWhite = document.querySelectorAll('.light-ball.white');

    ws.addEventListener('message', (message) => {
      if (message.data == 'ping') {
        ws.send('pong');
        return
      }

      let data = JSON.parse(message.data);
      if ('colorC' in data) {
        let valC = data['colorC'];
        if (valC == 1) {
          //toggleC.checked = true;
          ballCyan.forEach((cyan) => {
            cyan.classList.add('active');
          });
        }
      }
      if ('colorM' in data) {
        let valM = data['colorM'];
        if (valM == 1) {
          //toggleC.checked = true;
          ballMagenta.forEach((magenta) => {
            magenta.classList.add('active');
          });
        }
      }
      if ('colorY' in data) {
        let valY = data['colorY'];
        if (valY == 1) {
          //toggleC.checked = true;
          ballYellow.forEach((yellow) => {
            yellow.classList.add('active');
          });
        }
      }
      if ('colorW' in data) {
        let valW = data['colorW'];
        if (valW == 1) {
          //toggleC.checked = true;
          ballWhite.forEach((white) => {
            white.classList.add('active');
          });
        }
      }
    });
  </script>
  <!-- 這是阿陀與阿貝 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCJCxy6B9-Gt3RnxJbiYi2w_uIRd-yfSFM",
      authDomain: "bondjumaybeisthelast.firebaseapp.com",
      projectId: "bondjumaybeisthelast",
      storageBucket: "bondjumaybeisthelast.appspot.com",
      messagingSenderId: "573258856356",
      appId: "1:573258856356:web:503844c0fe7bee65aa7331"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const player = "blue"; // ⚠️ 改成 red 或 green 來分別測試

    const arrow = document.querySelector(".arrow");
    const numberDisplay = document.getElementById("number");

    let lastSentTime = 0;

    function rotating() {
      window.addEventListener('deviceorientation', async (event) => {
        let gamma = event.gamma;
        let bulu = 90 - (-gamma);

        if (bulu > 160) bulu = 0;
        else if (bulu > 110) bulu = 110;

        const motorAngle = Math.round((110 - bulu) / 110 * 180);
        numberDisplay.textContent = `馬達角度：${motorAngle}`;
        arrow.style.transform = `rotateX(${bulu}deg)`;

        // 傳送至 Firebase 每 400ms 一次
        const now = Date.now();
        if (now - lastSentTime >= 400) {
          lastSentTime = now;
          const docRef = doc(db, "motor_control", player);
          try {
            await updateDoc(docRef, { angle: motorAngle });
            console.log("已傳送 motorAngle:", motorAngle);
          } catch (err) {
            console.error("更新 Firebase 錯誤", err);
          }
        }

        // 修正手機翻轉視角
        if (window.orientation === -90) {
          document.body.style.transform = "rotate(180deg)";
        } else {
          document.body.style.transform = "rotate(0deg)";
        }
      });
    }

    arrow.addEventListener("click", () => {
      if (typeof DeviceOrientationEvent?.requestPermission === "function") {
        DeviceOrientationEvent.requestPermission().then((permissionState) => {
          if (permissionState === "granted") {
            rotating();
          } else {
            alert("請允許存取裝置方向！");
          }
        });
      } else {
        // Android 或桌機支援
        rotating();
      }
    });
  </script>


</body>

</html>